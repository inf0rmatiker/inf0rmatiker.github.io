<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Compiling Lustre Client :: Caleb Carlson | Documentation</title>
    <link rel="canonical" href="https://inf0rmatiker.github.io/docs-site/1/learning/lustre/compiling-lustre.html">
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://inf0rmatiker.github.io">Caleb Carlson | Documentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://inf0rmatiker.github.io/">Home</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs-site" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Projects</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">VU Meter</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../projects/vu-meter/vu-meter.html">VU Meter</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">PC Exhaust</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../projects/pc-exhaust/pc-exhaust.html">PC Exhaust</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Learning</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Kubernetes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../kubernetes/crds.html">CRDs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../kubernetes/k8s-api-resources.html">Kubernetes Resources</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../kubernetes/k8s-install.html">Kubernetes Install</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../kubernetes/kubectl.html">kubectl</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Lustre</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="benchmarks.html">Benchmarks</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="compiling-lustre.html">Compiling Lustre</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="development.html">Development</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lustre-client.html">Lustre Client</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lustre-server.html">Lustre Server</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lustre-networking.html">Lustre Networking</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Linux</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Installs</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/installs/rocky-install.html">Rocky Linux Install</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/installs/opensuse-install.html">OpenSUSE Linux Install</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../linux/isos.html">ISOs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../linux/rpms.html">RPMs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../linux/tmux.html">Tmux</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../linux/user-management.html">User Management</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Networking</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/networking/linux-networking.html">Linux</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/networking/mpi.html">MPI</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/networking/proxies.html">Proxies</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/networking/rdma.html">RDMA Programming</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/networking/socket_programming.html">Socket Programming</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/networking/ssh.html">SSH</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Storage</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/storage/benchmarks.html">Benchmarks</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/storage/filesystems.html">Filesystems</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/storage/drives.html">Drives</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Docker</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../docker/multiarch-building.html">Multi-Architecture Builds</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../docker/nginx-webserver.html">Nginx Webserver</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../docker/registry-proxy.html">Registry Proxy</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Asciinema</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../asciinema/asciinema.html">Asciinema</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">BMC Management</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../bmc-management/bmc-management.html">BMC Management</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Version Control</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../version-control/git/git.html">Git</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../version-control/github/github.html">GitHub</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Algorithms</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../algorithms/algorithms.html">Algorithms</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Machine Learning</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../machine-learning/benchmarks.html">Benchmarks</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../machine-learning/determinedai.html">Determined AI</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">REST APIs</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../rest-apis/api-security.html">Secure Development</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">InfiniBand</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../infiniband/infiniband.html">InfiniBand</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../infiniband/monitoring.html">Fabric Monitoring</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Languages</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">C</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/c/getopt.html">Getopt</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../languages/cpp/cpp.html">C++</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/arrays.html">Arrays</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/branch_control.html">Branch Control</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/classes.html">Classes</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/compiling.html">Compiling and Executing</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/development_environment.html">Development Environment</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/error_handling.html">Error Handling</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/functions.html">Functions</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/input_streams.html">Input Streams</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/macros.html">Macros</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/pointers.html">Pointers</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/references.html">References</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/structures.html">Stuctures</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/types.html">Types</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/vectors.html">Vectors</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../languages/go/go.html">Go</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Slurm</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../slurm/slurm.html">Slurm</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">GPUs</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../gpus/gds.html">GPUDirect Storage</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../gpus/numa.html">NUMA</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Switch Management</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../switch-management/switch-management.html">Switch Management</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">HPCM</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../hpcm/hpcm.html">HPCM</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Documentation</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../../index.html">Documentation</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Documentation</a></li>
    <li>Learning</li>
    <li>Lustre</li>
    <li><a href="compiling-lustre.html">Compiling Lustre</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Compiling Lustre Client</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Some references for compiling lustre:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://wiki.lustre.org/Compiling_Lustre">Compiling Lustre Documentation</a></p>
</li>
<li>
<p><a href="https://wiki.whamcloud.com/pages/viewpage.action?pageId=258179277">Walk-through: Build Lustre MASTER on RHEL/Rocky linux 8.7 from Git</a></p>
</li>
<li>
<p><a href="https://wiki.whamcloud.com/display/PUB/Rebuilding+the+Lustre-client+rpms+for+a+new+kernel">Rebuilding the Lustre Client RPMs for a New Kernel</a></p>
</li>
<li>
<p><a href="https://wiki.lustre.org/Compiling_Lustre#Lustre_Client_(All_other_Builds)">Compiling Lustre Client (non-DKMS)</a></p>
</li>
<li>
<p><a href="https://wiki.lustre.org/Compiling_Lustre#Lustre_Client_(DKMS_Packages_only)">Compiling Lustre Client (DKMS)</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compiling_in_container"><a class="anchor" href="#_compiling_in_container"></a>Compiling in Container</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The processes for compiling the client directly on the host where it will be used is easier than compiling it in a container to be used for a targeted environment.
Thus, I&#8217;ve separated out the two following sections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#on_host">Compiling on Host</a></p>
</li>
<li>
<p><a href="#in_container">Compiling in Container</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="on_host"><a class="anchor" href="#on_host"></a>Compiling on Host</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_using_rocky_8_6_host"><a class="anchor" href="#_using_rocky_8_6_host"></a>Using Rocky 8.6 Host</h3>
<div class="paragraph">
<p>Here we&#8217;ll be using Rocky Linux 8.6 Minimal as our base installation medium, and will be compiling on the baremetal host OS.
This will effectively allow us to compile Lustre for the OS/kernel installed.</p>
</div>
<div class="sect3">
<h4 id="_prerequisites_and_dependencies"><a class="anchor" href="#_prerequisites_and_dependencies"></a>Prerequisites and Dependencies</h4>
<div class="paragraph">
<p>There are quite a few prerequisites that need to be satisfied to get a proper build environment before we can compile anything.</p>
</div>
</div>
<div class="sect3">
<h4 id="_setup_rocky_8_6_repositories"><a class="anchor" href="#_setup_rocky_8_6_repositories"></a>Setup Rocky 8.6 Repositories</h4>
<div class="paragraph">
<p>Out of the box, Rocky 8.6 points to Rocky 8.8 repositories for packages. This will become problematic if we try to install
packages that depend on a newer version of the kernel, as they&#8217;ll install that newer version of the <code>kernel-core</code> and <code>kernel-devel</code>.
The kernel version Rocky 8.6 runs out of the box is <code>4.18.0-372.9.1.el8.x86_64</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">[root@mawenzi-04 ~]# uname -r
4.18.0-372.9.1.el8.x86_64</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if you try to install packages like <code>kernel-devel</code>, you&#8217;ll see it will find the one for a newer kernel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">[root@mawenzi-04 ~]# dnf search -v kernel-devel
Loaded plugins: builddep, changelog, config-manager, copr, debug, debuginfo-install, download, generate_completion_cache, groups-manager, needs-restarting, playground, repoclosure, repodiff, repograph, repomanage, reposync
DNF version: 4.7.0
cachedir: /var/cache/dnf
Last metadata expiration check: 1:09:48 ago on Fri 21 Jul 2023 10:34:42 AM MDT.
=================================================================== Name Exactly Matched: kernel-devel ====================================================================
kernel-devel.x86_64 : Development package for building kernel modules to match the kernel
Repo        : baseos
Matched from:
Provide    : kernel-devel = 4.18.0-477.15.1.el8_8</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will cause incompatibilities down the road for compiling Lustre since we&#8217;ll essentially be compiling it for a newer kernel version, the one Rocky 8.8 uses.</p>
</div>
<div class="paragraph">
<p>Instead, we need to change Rocky 8.6&#8217;s <code>yum</code> repository configurations over to use the <em>true</em> <a href="https://dl.rockylinux.org/vault/rocky/8.6/">Rocky 8.6 Vault repositories</a>.</p>
</div>
<div class="paragraph">
<p>To view what repositories are currently in enabled, run <code>yum repolist -v</code>. Note how all the repos referenced are for Rocky 8.8.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">[root@mawenzi-04 lustre-release]# yum repolist -v
Loaded plugins: builddep, changelog, config-manager, copr, debug, debuginfo-install, download, generate_completion_cache, groups-manager, needs-restarting, playground, repoclosure, repodiff, repograph, repomanage, reposync
YUM version: 4.7.0
cachedir: /var/cache/dnf
Last metadata expiration check: 0:12:12 ago on Fri 21 Jul 2023 10:34:42 AM MDT.
Repo-id            : appstream
Repo-name          : Rocky Linux 8 - AppStream
Repo-revision      : 8.8
Repo-distro-tags      : [cpe:/o:rocky:rocky:8]:  ,  , 8, L, R, c, i, k, n, o, u, x, y
Repo-updated       : Wed 19 Jul 2023 10:08:22 AM MDT
Repo-pkgs          : 7,550
Repo-available-pkgs: 6,103
Repo-size          : 12 G
Repo-mirrors       : https://mirrors.rockylinux.org/mirrorlist?arch=x86_64&amp;repo=AppStream-8
Repo-baseurl       : http://mirrors.rit.edu/rocky/8.8/AppStream/x86_64/os/ (43 more)
Repo-expire        : 172,800 second(s) (last: Fri 21 Jul 2023 10:34:40 AM MDT)
Repo-filename      : /etc/yum.repos.d/Rocky-AppStream.repo

Repo-id            : baseos
Repo-name          : Rocky Linux 8 - BaseOS
Repo-revision      : 8.8
Repo-distro-tags      : [cpe:/o:rocky:rocky:8]:  ,  , 8, L, R, c, i, k, n, o, u, x, y
Repo-updated       : Wed 19 Jul 2023 10:08:27 AM MDT
Repo-pkgs          : 1,857
Repo-available-pkgs: 1,855
Repo-size          : 2.3 G
Repo-mirrors       : https://mirrors.rockylinux.org/mirrorlist?arch=x86_64&amp;repo=BaseOS-8
Repo-baseurl       : http://mirrors.rit.edu/rocky/8.8/BaseOS/x86_64/os/ (43 more)
Repo-expire        : 172,800 second(s) (last: Fri 21 Jul 2023 10:34:41 AM MDT)
Repo-filename      : /etc/yum.repos.d/Rocky-BaseOS.repo

Repo-id            : extras
Repo-name          : Rocky Linux 8 - Extras
Repo-revision      : 1689203561
Repo-distro-tags      : [cpe:/o:rocky:rocky:8]:  ,  , 8, L, R, c, i, k, n, o, u, x, y
Repo-updated       : Wed 12 Jul 2023 05:12:41 PM MDT
Repo-pkgs          : 52
Repo-available-pkgs: 52
Repo-size          : 3.3 M
Repo-mirrors       : https://mirrors.rockylinux.org/mirrorlist?arch=x86_64&amp;repo=extras-8
Repo-baseurl       : https://rocky-linux-us-west4.production.gcp.mirrors.ctrliq.cloud/pub/rocky//8.8/extras/x86_64/os/ (43 more)
Repo-expire        : 172,800 second(s) (last: Fri 21 Jul 2023 10:34:42 AM MDT)
Repo-filename      : /etc/yum.repos.d/Rocky-Extras.repo
Total packages: 9,459</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll switch these over to the Rocky 8.6 repos.</p>
</div>
<div class="paragraph">
<p>Create a new file <code>/etc/yum.repos.d/Rocky-86-Development.repo</code> by running the following command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &gt;&gt; /etc/yum.repos.d/Rocky-86-Development.repo &lt;&lt; EOF
# Rocky-AppStream.repo
[appstream86]
name=Rocky Linux $releasever - AppStream
#mirrorlist=https://mirrors.rockylinux.org/mirrorlist?arch=$basearch&amp;repo=AppStream-$releasever
baseurl=https://dl.rockylinux.org/vault/rocky/8.6/AppStream/x86_64/os/
gpgcheck=1
enabled=1
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-rockyofficial

# Rocky-BaseOS.repo
[baseos86]
name=Rocky Linux $releasever - BaseOS
#mirrorlist=https://mirrors.rockylinux.org/mirrorlist?arch=$basearch&amp;repo=BaseOS-$releasever
baseurl=https://dl.rockylinux.org/vault/rocky/8.6/BaseOS/x86_64/os/
gpgcheck=1
enabled=1
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-rockyofficial

# Rocky-Devel.repo
[devel86]
name=Rocky Linux $releasever - Devel WARNING! FOR BUILDROOT AND KOJI USE
#mirrorlist=https://mirrors.rockylinux.org/mirrorlist?arch=$basearch&amp;repo=Devel-$releasever
baseurl=https://dl.rockylinux.org/vault/rocky/8.6/Devel/x86_64/os/
gpgcheck=1
enabled=1
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-rockyofficial

# Rocky-Extras.repo
[extras86]
name=Rocky Linux $releasever - Extras
#mirrorlist=https://mirrors.rockylinux.org/mirrorlist?arch=$basearch&amp;repo=extras-$releasever
baseurl=https://dl.rockylinux.org/vault/rocky/8.6/extras/x86_64/os/
gpgcheck=1
enabled=1
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-rockyofficial

# Rocky-PowerTools.repo
[powertools86]
name=Rocky Linux $releasever - PowerTools
#mirrorlist=https://mirrors.rockylinux.org/mirrorlist?arch=$basearch&amp;repo=PowerTools-$releasever
baseurl=https://dl.rockylinux.org/vault/rocky/8.6/PowerTools/x86_64/os/
gpgcheck=1
enabled=1
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-rockyofficial
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, disable the original 8.8 repos, and enable the 8.6 repos (if you haven&#8217;t already).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf config-manager --disable appstream baseos extras
dnf config-manager --enable appstream86 baseos86 extras86 devel86 powertools86</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, when we search for <code>kernel-devel</code>, we see the correct kernel version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">[root@mawenzi-04 yum.repos.d]# dnf search kernel-devel -v
Loaded plugins: builddep, changelog, config-manager, copr, debug, debuginfo-install, download, generate_completion_cache, groups-manager, needs-restarting, playground, repoclosure, repodiff, repograph, repomanage, reposync
DNF version: 4.7.0
cachedir: /var/cache/dnf
Rocky Linux 8 - AppStream                                                                                                                  1.4 MB/s |  11 MB     00:07
Rocky Linux 8 - BaseOS                                                                                                                     3.7 MB/s | 9.0 MB     00:02
Rocky Linux 8 - Extras                                                                                                                     8.0 kB/s |  12 kB     00:01
=================================================================== Name Exactly Matched: kernel-devel ====================================================================
kernel-devel.x86_64 : Development package for building kernel modules to match the kernel
Repo        : baseos86
Matched from:
Provide    : kernel-devel = 4.18.0-372.32.1.el8_6</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_prerequisite_packages"><a class="anchor" href="#_prerequisite_packages"></a>Prerequisite Packages</h4>
<div class="paragraph">
<p>Install prerequisite software tools on the build server:</p>
</div>
<div class="paragraph">
<p>First, install DNF plugins package.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf install -y dnf-plugins-core</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, install Extra Packages for Enterprise Linux (EPEL) release.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf install -y epel-release</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install the "Development Tools" group. This will also pull in the <code>kernel-headers</code>
and <code>kernel-devel</code> packages as dependencies.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf groupinstall -y "Development Tools"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install the remaining dependecies for compiling the Lustre client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf install -y         \
    audit-libs-devel   \
    bc                 \
    binutils-devel     \
    git                \
    json-c-devel       \
    kernel-abi-stablelists \
    kernel-devel       \
    kernel-debug-devel \
    kernel-rpm-macros  \
    libaio-devel       \
    libattr-devel      \
    libblkid-devel     \
    libmount           \
    libmount-devel     \
    libnl3-devel       \
    libselinux-devel   \
    libssh-devel       \
    libtirpc-devel     \
    libuuid-devel      \
    libyaml            \
    libyaml-devel      \
    llvm-toolset       \
    pciutils-devel     \
    ncurses-devel      \
    openssl-devel      \
    perl               \
    perl-devel         \
    python39           \
    python3-devel      \
    python3-docutils   \
    redhat-lsb         \
    texinfo            \
    texinfo-tex</code></pre>
</div>
</div>
<div class="paragraph">
<p>Update <code>dnf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dnf update</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mofed_drivers"><a class="anchor" href="#_mofed_drivers"></a>MOFED Drivers</h4>
<div class="paragraph">
<p>If we&#8217;re compiling the Lustre client with MOFED InfiniBand support, we need to make sure we&#8217;ve built and installed MOFED drivers for the unpatched kernel we&#8217;re currently running. In our case for Rocky 8.6, this is <code>4.18.0-372.9.1.el8.x86_64</code>.</p>
</div>
<div class="paragraph">
<p>View <a href="https://docs.nvidia.com/networking/display/MLNXOFEDv461000/Installing+Mellanox+OFED">Nvidia&#8217;s Installing Mellanox OFED</a> or my <a href="../infiniband/infiniband.html#_mofed_installation" class="xref page">InfiniBand MOFED Installation notes</a> for more depth information. Below is a brief synopsis of the install process.</p>
</div>
<div class="paragraph">
<p>Go to the <a href="https://network.nvidia.com/products/infiniband-drivers/linux/mlnx_ofed/">Nvidia Download Center</a>, and download <code>5.4-3.7.5.0-LTS &#8594; RHEL/CentOS/Rocky &#8594; RHEL/Rocky 8.6 &#8594; MLNX_OFED_LINUX-5.4-3.7.5.0-rhel8.6-x86_64.tgz</code> to your build environment home.</p>
</div>
<div class="paragraph">
<p>Untar it: <code>tar -xzvf MLNX_OFED_LINUX-5.4-3.7.5.0-rhel8.6-x86_64.tgz</code></p>
</div>
<div class="paragraph">
<p>There&#8217;s a few ways to go about installing MOFED here. One option is to use the <code>mlnxofedinstall</code> script provided to install. The other is to use your package manager, in our case DNF, to install the RPMs as a local repo.</p>
</div>
<div class="paragraph">
<p><strong>Using DNF</strong>:</p>
</div>
<div class="paragraph">
<p>Create a new yum repo, enabled, with GPG check disabled.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &gt;&gt; /etc/yum.repos.d/Mellanox-OFED.repo &lt;&lt; EOF
[mlnx_ofed]
name=MLNX_OFED Repository
baseurl=file:///root/MLNX_OFED_LINUX-5.4-3.7.5.0-rhel8.6-x86_64/RPMS
enabled=1
gpgcheck=0
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running a <code>dnf search mlnx-ofed-</code> should show:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">[root@mawenzi-04 MLNX_OFED_LINUX-5.4-3.7.5.0-rhel8.6-x86_64]# dnf search mlnx-ofed-
Rocky Linux 8 - Devel WARNING! FOR BUILDROOT AND KOJI USE                                                                                  2.1 MB/s | 4.3 MB     00:02
Last metadata expiration check: 0:00:01 ago on Fri 04 Aug 2023 09:45:38 AM MDT.
======================================================================== Name Matched: mlnx-ofed- =========================================================================
mlnx-ofed-all.noarch : MLNX_OFED all installer package  (with KMP support)
mlnx-ofed-all-user-only.noarch : MLNX_OFED all-user-only installer package  (User Space packages only)
mlnx-ofed-basic.noarch : MLNX_OFED basic installer package  (with KMP support)
mlnx-ofed-basic-user-only.noarch : MLNX_OFED basic-user-only installer package  (User Space packages only)
mlnx-ofed-bluefield.noarch : MLNX_OFED bluefield installer package  (with KMP support)
mlnx-ofed-bluefield-user-only.noarch : MLNX_OFED bluefield-user-only installer package  (User Space packages only)
mlnx-ofed-dpdk.noarch : MLNX_OFED dpdk installer package  (with KMP support)
mlnx-ofed-dpdk-upstream-libs.noarch : MLNX_OFED dpdk-upstream-libs installer package  (with KMP support)
mlnx-ofed-dpdk-upstream-libs-user-only.noarch : MLNX_OFED dpdk-upstream-libs-user-only installer package  (User Space packages only)
mlnx-ofed-dpdk-user-only.noarch : MLNX_OFED dpdk-user-only installer package  (User Space packages only)
mlnx-ofed-eth-only-user-only.noarch : MLNX_OFED eth-only-user-only installer package  (User Space packages only)
mlnx-ofed-guest.noarch : MLNX_OFED guest installer package  (with KMP support)
mlnx-ofed-guest-user-only.noarch : MLNX_OFED guest-user-only installer package  (User Space packages only)
mlnx-ofed-hpc.noarch : MLNX_OFED hpc installer package  (with KMP support)
mlnx-ofed-hpc-user-only.noarch : MLNX_OFED hpc-user-only installer package  (User Space packages only)
mlnx-ofed-hypervisor.noarch : MLNX_OFED hypervisor installer package  (with KMP support)
mlnx-ofed-hypervisor-user-only.noarch : MLNX_OFED hypervisor-user-only installer package  (User Space packages only)
mlnx-ofed-kernel-only.noarch : MLNX_OFED kernel-only installer package  (with KMP support)
mlnx-ofed-vma.noarch : MLNX_OFED vma installer package  (with KMP support)
mlnx-ofed-vma-eth.noarch : MLNX_OFED vma-eth installer package  (with KMP support)
mlnx-ofed-vma-eth-user-only.noarch : MLNX_OFED vma-eth-user-only installer package  (User Space packages only)
mlnx-ofed-vma-user-only.noarch : MLNX_OFED vma-user-only installer package  (User Space packages only)
mlnx-ofed-vma-vpi.noarch : MLNX_OFED vma-vpi installer package  (with KMP support)
mlnx-ofed-vma-vpi-user-only.noarch : MLNX_OFED vma-vpi-user-only installer package  (User Space packages only)
mlnx-ofed-xlio.noarch : MLNX_OFED xlio installer package  (with KMP support)
mlnx-ofed-xlio-user-only.noarch : MLNX_OFED xlio-user-only installer package  (User Space packages only)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install <code>mlnx-ofed-all</code> (with KMP support) using <code>dnf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf install mlnx-ofed-all</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once this has finished, you should have installed all the required kernel modules and supporting packages that the Lustre build process needs to reference. It is not required to actually <em>load</em> the modules; they just need to be present. You can check their existence under <code>/usr/src/</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">[root@mawenzi-04 MLNX_OFED_LINUX-5.4-3.7.5.0-rhel8.6-x86_64]# ls /usr/src/
debug  kernels  mlnx-ofa_kernel-5.4  ofa_kernel  ofa_kernel-5.4</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Using the Install Script</strong>:</p>
</div>
<div class="paragraph">
<p>TODO: This has not been explored enough to capture notes on.</p>
</div>
</div>
<div class="sect3">
<h4 id="_building_client"><a class="anchor" href="#_building_client"></a>Building Client</h4>
<div class="paragraph">
<p>Clone the Lustre repository from whamcloud.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone https://review.whamcloud.com/fs/lustre-release</code></pre>
</div>
</div>
<div class="paragraph">
<p>Prepare the Makefile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sh autogen.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure the build for just building the client, and point it at your kernel/MOFED sources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./configure \
    --disable-server \
    --enable-client \
    --with-linux=/usr/src/kernels/4.18.0-372.32.1.el8_6.x86_64 \
    --with-o2ib=/usr/src/ofa_kernel/default</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>make</code> the RPMs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">make rpms</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once it finishes, you should end up with all the RPMs and sources dumped into the <code>lustre-release</code> repo root:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">[root@mawenzi-04 lustre-release]# ls ~/lustre-release/{*.rpm,*.tar.gz}
/root/lustre-release/kmod-lustre-client-2.15.56_124_g3ebc8e0-1.el8.x86_64.rpm
/root/lustre-release/kmod-lustre-client-debuginfo-2.15.56_124_g3ebc8e0-1.el8.x86_64.rpm
/root/lustre-release/kmod-lustre-client-tests-2.15.56_124_g3ebc8e0-1.el8.x86_64.rpm
/root/lustre-release/kmod-lustre-client-tests-debuginfo-2.15.56_124_g3ebc8e0-1.el8.x86_64.rpm
/root/lustre-release/lustre-2.15.56_124_g3ebc8e0-1.src.rpm
/root/lustre-release/lustre-2.15.56_124_g3ebc8e0.tar.gz
/root/lustre-release/lustre-client-2.15.56_124_g3ebc8e0-1.el8.x86_64.rpm
/root/lustre-release/lustre-client-debuginfo-2.15.56_124_g3ebc8e0-1.el8.x86_64.rpm
/root/lustre-release/lustre-client-debugsource-2.15.56_124_g3ebc8e0-1.el8.x86_64.rpm
/root/lustre-release/lustre-client-devel-2.15.56_124_g3ebc8e0-1.el8.x86_64.rpm
/root/lustre-release/lustre-client-tests-2.15.56_124_g3ebc8e0-1.el8.x86_64.rpm
/root/lustre-release/lustre-client-tests-debuginfo-2.15.56_124_g3ebc8e0-1.el8.x86_64.rpm
/root/lustre-release/lustre-iokit-2.15.56_124_g3ebc8e0-1.el8.x86_64.rpm</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="in_container"><a class="anchor" href="#in_container"></a>Compiling in Container</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_compiling_within_an_opensuse_15_5_docker_container"><a class="anchor" href="#_compiling_within_an_opensuse_15_5_docker_container"></a>Compiling within an OpenSUSE 15.5 Docker Container</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create the following <code>zypper</code> repofile for Mellanox OFED:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &gt;&gt; /etc/zypp/repos.d/Mellanox-OFED.repo &lt;&lt; EOF
[mlnx_ofed_5.8-3.0.7.0_base]
name=Mellanox Technologies sles15sp5-$basearch mlnx_ofed 5.8-3.0.7.0 GA
baseurl=http://linux.mellanox.com/public/repo/mlnx_ofed/5.8-3.0.7.0/sles15sp5/$basearch
enabled=1
autorefresh=1
path=/
type=rpm-md
keeppackages=0
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the following <code>Dockerfile</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-dockerfile hljs" data-lang="dockerfile">FROM opensuse-leap:15.5 AS oss-leap-155

RUN zypper install -y vim tar git python39

RUN zypper install -y \
    kernel-default-devel \
    kernel-devel \
    kernel-syms \
    kernel-source

RUN zypper install -y libyaml-devel libmount-devel


ENTRYPOINT ["/usr/bin/bash"]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_on_host_builds"><a class="anchor" href="#_on_host_builds"></a>On-Host Builds</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_building_for_ubuntu"><a class="anchor" href="#_building_for_ubuntu"></a>Building for Ubuntu</h3>
<div class="paragraph">
<p>Here we&#8217;re building for Ubuntu 22.04.</p>
</div>
<div class="paragraph">
<p>Install the build dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

set -ex

# Install dependencies
apt-get install -y \
	module-assistant \
	libreadline-dev \
	debhelper \
	dpatch \
	automake \
	pkg-config \
	libtool \
	libyaml-dev \
	libnl-genl-3-dev \
	libselinux-dev \
	libsnmp-dev \
	mpi-default-dev \
	bzip2 \
	quilt \
	linux-headers-$(uname -r) \
	rsync \
	libssl-dev \
	libpython3-dev \
	swig

LUSTRE_DIR=/root/ccarlson/lustre-release

# e.g: generic
KERNEL_FLAVOR=$(uname -r | tr '-' '\n' | tail -1)

# e.g: 5.15.0-83
KERNEL_VERSION=$(uname -r | sed -e "s:-${KERNEL_FLAVOR}$::g")

# e.g: /usr/src/linux-headers-5.15.0-83
LINUX_KERNEL_DIR=$(ls -d -1 /usr/src/linux-*headers-${KERNEL_VERSION})

# e.g: /usr/src/linux-headers-5.15.0-83-generic/
LINUX_OBJ_DIR=$(ls -d -1 /usr/src/linux-*headers-${KERNEL_VERSION}-${KERNEL_FLAVOR})

# e.g: /usr/src/ofa_kernel/default
# MOFED_SRC_DIR="/usr/src/mlnx-ofed-kernel-23.07"
MOFED_SRC_DIR="/usr/src/ofa_kernel/default"

# Configure build options then build debian packages
cd $LUSTRE_DIR &amp;&amp; sh autogen.sh &amp;&amp; ./configure \
	--disable-server \
	--enable-client \
	--with-linux=${LINUX_KERNEL_DIR} \
	--with-linux-obj=${LINUX_OBJ_DIR} \
	--with-o2ib=${MOFED_SRC_DIR} \
	&amp;&amp; make debs</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright Â© 2023 Caleb Carlson. All rights reserved.
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lustre Development :: Caleb Carlson | Docs Site</title>
    <link rel="canonical" href="https://inf0rmatiker.github.io/docs-site/1/learning/lustre/development.html">
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://inf0rmatiker.github.io">Caleb Carlson | Docs Site</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://inf0rmatiker.github.io/">Home</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs-site" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../../index.html">Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Projects</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">VU Meter</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../projects/vu-meter/vu-meter.html">VU Meter</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">PC Exhaust</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../projects/pc-exhaust/pc-exhaust.html">PC Exhaust</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Learning</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Kubernetes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../kubernetes/crds.html">CRDs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../kubernetes/k8s-api-resources.html">Kubernetes Resources</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../kubernetes/k8s-install.html">Kubernetes Install</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../kubernetes/kubectl.html">kubectl</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Lustre</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="benchmarks.html">Benchmarks</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="compiling-lustre.html">Compiling Lustre</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="development.html">Development</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lustre-client.html">Lustre Client</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lustre-server.html">Lustre Server</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lustre-networking.html">Lustre Networking</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Linux</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Installs</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/installs/rocky-install.html">Rocky Linux Install</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/installs/opensuse-install.html">OpenSUSE Linux Install</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../linux/isos.html">ISOs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../linux/rpms.html">RPMs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../linux/tmux.html">Tmux</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../linux/user-management.html">User Management</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Networking</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/networking/linux-networking.html">Linux</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/networking/mpi.html">MPI</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/networking/proxies.html">Proxies</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/networking/rdma.html">RDMA Programming</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/networking/socket_programming.html">Socket Programming</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/networking/ssh.html">SSH</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Storage</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/storage/benchmarks.html">Benchmarks</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/storage/filesystems.html">Filesystems</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../linux/storage/drives.html">Drives</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../linux/vms/virtual-machines.html">Virtual Machines</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Docker</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../docker/multiarch-building.html">Multi-Architecture Builds</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../docker/nginx-webserver.html">Nginx Webserver</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../docker/registry-proxy.html">Registry Proxy</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../asciinema/asciinema.html">Asciinema</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../bmc-management/bmc-management.html">BMC Management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Version Control</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../version-control/git/git.html">Git</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../version-control/github/github.html">GitHub</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Algorithms</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../algorithms/dynamic-programming.html">Dynamic Programming</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../algorithms/sliding-window.html">Sliding Window</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Machine Learning</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../machine-learning/benchmarks.html">Benchmarks</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../machine-learning/determinedai.html">Determined AI</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">REST APIs</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../rest-apis/api-security.html">Secure Development</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">InfiniBand</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../infiniband/infiniband.html">InfiniBand</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../infiniband/monitoring.html">Fabric Monitoring</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Languages</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">C</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/c/getopt.html">Getopt</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../languages/cpp/cpp.html">C++</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/arrays.html">Arrays</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/branch_control.html">Branch Control</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/classes.html">Classes</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/compiling.html">Compiling and Executing</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/development_environment.html">Development Environment</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/error_handling.html">Error Handling</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/functions.html">Functions</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/input_streams.html">Input Streams</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/macros.html">Macros</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/pointers.html">Pointers</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/references.html">References</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/structures.html">Stuctures</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/types.html">Types</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../languages/cpp/vectors.html">Vectors</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../languages/go/go.html">Go</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../slurm/slurm.html">Slurm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">GPUs</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../gpus/gds.html">GPUDirect Storage</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../gpus/numa.html">NUMA</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../switch-management/switch-management.html">Switch Management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hpcm/hpcm.html">HPCM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">todo</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../todo/todo.html">todo</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Documentation</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../../index.html">Documentation</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Documentation</a></li>
    <li>Learning</li>
    <li>Lustre</li>
    <li><a href="development.html">Development</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lustre Development</h1>
<div class="sect1">
<h2 id="_git_configuration"><a class="anchor" href="#_git_configuration"></a>Git Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After cloning the Git repo, replace <code>.git/config</code> with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">[core]
        repositoryformatversion = 0
        filemode = true
        bare = false
        logallrefupdates = true
        ignorecase = true
        precomposeunicode = true
[remote "origin"]
        url = ssh://carlsonc@es-gerrit.hpc.amslabs.hpecorp.net:29418/lustre-wc-rel
        fetch = +refs/heads/*:refs/remotes/origin/*
        fetch = +refs/dev/*:refs/remotes/origin/dev/*
[remote "gh"]
        url = git@github.hpe.com:hpe/hpc-lus-filesystem.git
        fetch = +refs/heads/*:refs/remotes/gh/*
[remote "wc"]
        url = ssh://carlsonc@review.whamcloud.com:29418/fs/lustre-release
        fetch = +refs/heads/*:refs/remotes/wc/*
[branch "master"]
        remote = origin
        merge = refs/heads/master
[branch "cray-2.15-int"]
        remote = origin
        merge = refs/heads/cray-2.15-int
[user]
        email = caleb.carlson@hpe.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add in any <code>branch</code> entries for tracking remote dev counterparts. This will let
you <code>git pull</code> from the remote to your local version.</p>
</div>
<div class="sect2">
<h3 id="_rebasing_a_development_branch"><a class="anchor" href="#_rebasing_a_development_branch"></a>Rebasing a Development Branch</h3>
<div class="paragraph">
<p>Occasionally the integration branch <code>cray-2.15-int</code> branch gets rebased on the release branch <code>cray-2.15</code>.</p>
</div>
<div class="paragraph">
<p>When things are cherry-picked into the <code>cray-2.15</code> the commits get different commit hashes
than what&#8217;s in <code>cray-2.15-int</code>. Also the order can change from what&#8217;s in <code>cray-2.15-int</code>.</p>
</div>
<div class="paragraph">
<p>The history of the release branch totally changes from what&#8217;s in the integration branch.</p>
</div>
<div class="paragraph">
<p>When you try to rebase your dev branch, using <code>git rebase -i origin/cray-2.15-int</code>
(with the old <code>cray-2.15-int</code> history) onto the new <code>cray-2.15-int</code>, git will
"mostly" find the same commits and skip them, but it won&#8217;t catch all of them.
The ones it doesn&#8217;t catch will be lumped into a list with your actual new commits
on <code>cray-2.15-int</code>. All you have to do is to <em>not pick</em> the commits you didn&#8217;t commit,
because they&#8217;re most likely already there in <code>cray-2.15-int</code>, it&#8217;s just that git
didn&#8217;t find a match for them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git checkout LUS-12345-foo
git fetch origin
git rebase -i origin/cray-2.15-int</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, only <code>pick</code> your commits, deleting the rest.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ssh_configuration"><a class="anchor" href="#_ssh_configuration"></a>SSH Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure you have SSH entries configured for the different git remotes.
Gerrit is a little outdated so you&#8217;ll have to use an older RSA key.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console"># GitHub
Host github.com
  Hostname github.com
  IdentityFile ~/.ssh/caleb_id_ecdsa

# Es-Gerrit
Host es-gerrit.hpc.amslabs.hpecorp.net
  Hostname es-gerrit.hpc.amslabs.hpecorp.net
  KexAlgorithms +diffie-hellman-group1-sha1
  HostkeyAlgorithms +ssh-rsa
  PubkeyAcceptedAlgorithms +ssh-rsa
  User carlsonc
  IdentityFile ~/.ssh/id_rsa

# Whamcloud
Host review.whamcloud.com
  HostName review.whamcloud.com
  User carlsonc
  IdentityFile ~/.ssh/caleb_id_ecdsa

# HPE GitHub
Host github.hpe.com
  Hostname github.hpe.com
  IdentityFile ~/.ssh/caleb_id_ecdsa</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_push_dev_branch_to_hpe_gh_remote"><a class="anchor" href="#_push_dev_branch_to_hpe_gh_remote"></a>Push dev branch to HPE GH remote</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">hornc@cassini-hosta:~/lustre-wc-rel&gt; git branch dev/LUS-12345-test
hornc@cassini-hosta:~/lustre-wc-rel&gt; git push gh dev/LUS-12345-test
Total 0 (delta 0), reused 0 (delta 0), pack-reused 0
remote:
remote: Create a pull request for 'dev/LUS-12345-test' on GitHub by visiting:
remote:      https://github.hpe.com/hpe/hpc-lus-filesystem/pull/new/dev/LUS-12345-test
remote:
To github.hpe.com:hpe/hpc-lus-filesystem.git
 * [new branch]            dev/LUS-12345-test -&gt; dev/LUS-12345-test
hornc@cassini-hosta:~/lustre-wc-rel&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_check_out_branch_from_another_remote"><a class="anchor" href="#_check_out_branch_from_another_remote"></a>Check out branch from another remote</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure you&#8217;ve fetched the latest versions of the remote branches first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">➜  lustre-wc-rel git:(cray-2.15-int) git checkout gh/release/uss-1.1
Note: switching to 'gh/release/uss-1.1'.

You are in 'detached HEAD' state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by switching back to a branch.

If you want to create a new branch to retain commits you create, you may
do so (now or later) by using -c with the switch command. Example:

  git switch -c &lt;new-branch-name&gt;

Or undo this operation with:

  git switch -

Turn off this advice by setting config variable advice.detachedHead to false

HEAD is now at 4846b50d77 LUS-12377 dkms: mofed fallback to kABI
➜  lustre-wc-rel git:(4846b50d77) git checkout wc/master
Previous HEAD position was 4846b50d77 LUS-12377 dkms: mofed fallback to kABI
HEAD is now at 8b6719f1b3 LU-17887 obd: do not update obd_memory from RCU</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_gathering_build_logs_for_trivial_changes"><a class="anchor" href="#_gathering_build_logs_for_trivial_changes"></a>Gathering Build Logs for Trivial Changes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clone <code>lustre-wc-rel</code> on a test system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

set -ex

# Git settings
cd lustre-wc-rel
git fetch -p
git reset --hard HEAD
git checkout &lt;branch&gt;
git clean -dfx &gt; /dev/null
git log --pretty=oneline | head -4

# Modify this for respective distro you're using
KERNEL_VERSION="5.14.21-150500.53"
ARCH="x86_64"
LINUX_DIR=$(ls -d /usr/src/linux-${KERNEL_VERSION})
LINUX_OBJ_DIR=$(ls -d /usr/src/linux-${KERNEL_VERSION}-obj/${ARCH}/default)

./LUSTRE-VERSION-GEN

# Modify this to include configure options for the build you're doing
sh ./autogen.sh
./configure \
  --enable-client \
  --disable-server \
  --disable-gss-keyring \
  --enable-gss="no" \
  --enable-mpitests="no" \
  --enable-ldap="no" \
  --with-o2ib="/usr/src/ofa_kernel/default" \
  --with-linux="$LINUX_DIR" \
  --with-linux-obj="$LINUX_OBJ_DIR"

make rpms
rpm -q --requires lustre-client-2.15.3.*.x86_64.rpm | grep ldap</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, run <code>./build.sh 2&gt;&amp;1 | tee build_&lt;commit-id&gt;.log</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_with_rpmbuild"><a class="anchor" href="#_building_with_rpmbuild"></a>Building with <code>rpmbuild</code></h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

function print_usage {
  echo -e "\nUsage: ./build_lustre_client.sh &lt;lustre_version&gt; &lt;kernel_version&gt;"
  echo -e "Example:\n\t./build_lustre_client.sh cray-2.15-int 5.14.21-150500.53"
}

function error {
  echo "$@" 1&gt;&amp;2; exit 1
}

# Check args
[[ $# -ne 2 ]] &amp;&amp; print_usage &amp;&amp; exit 1

set -ex

LUSTRE_REFSPEC=$1
KERNEL_VERSION=$2

# Set architecture type, arm64 or x86_64. Default is x86_64.
ARCH="x86_64"
[[ $PLATFORM == "linux/arm64" ]] &amp;&amp; ARCH="aarch64"

cd lustre-wc-rel
#  git fetch --all --tags --prune &amp;&amp; \
#  git checkout ${LUSTRE_REFSPEC}

sh ./autogen.sh &amp;&amp; ./configure --enable-dist || error "Unable to autogen and configure"
make lustre.spec lustre-dkms.spec dist Makefile || error "Unable to make dist and spec files"

# Find linux kernel source and linux kernel object source.
# On RHEL they're the same directory, but OpenSUSE and other
# distros they are usually different directories under /usr/src.
LINUX_DIR=$(ls -d /usr/src/linux-${KERNEL_VERSION})
LINUX_OBJ_DIR=$(ls -d /usr/src/linux-${KERNEL_VERSION}-obj/${ARCH}/default)
RPMBUILD_DIR="/tmp/work/rpmbuild"

# Create rpmbuild dir
rm -rf $RPMBUILD_DIR/
mkdir -p $RPMBUILD_DIR/SPECS $RPMBUILD_DIR/SOURCES
cp -v rpm/* lustre-*.tar.gz $RPMBUILD_DIR/SOURCES/
cp -v lustre.spec lustre-dkms.spec $RPMBUILD_DIR/SPECS

CONFIGURE_ARGS="'--disable-gss-keyring' '--enable-gss=no' '--enable-mpitests=no'"
[[ -n ${MOFED_VERSION} ]] &amp;&amp; CONFIGURE_ARGS="${CONFIGURE_ARGS} '--with-o2ib=/usr/src/ofa_kernel/default'"

# Build the userspace, devel, iokit, debug, and kmod/kmp RPMs
rpmbuild \
  --without mpi \
  --without servers \
  --without lustre_tests \
  --without lustre_iokit \
  --define "_topdir $RPMBUILD_DIR" \
  --define "kobjdir $LINUX_OBJ_DIR" \
  --define "kver $KERNEL_VERSION" \
  --define "kversion $KERNEL_VERSION" \
  --define "kdir $LINUX_DIR" \
  --define "_with_lnet_dlc lnet_dlc" \
  --define "configure_args $CONFIGURE_ARGS" \
  -ba lustre.spec 2&gt;&amp;1 | tee /tmp/work/rpmbuild.log \
  || error "Failed to build lustre.spec"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_debugging"><a class="anchor" href="#_debugging"></a>Debugging</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_using_the_ring_buffer"><a class="anchor" href="#_using_the_ring_buffer"></a>Using the Ring Buffer</h3>
<div class="paragraph">
<p>Lustre stores debug statements in a ring buffer on the system. What goes into
this ring buffer is determined by the module parameter <code>debug</code>.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example default <code>debug</code> parameter value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">mawenzi-06:~ # lctl get_param debug
debug=ioctl neterror warning error emerg ha config console lfsck</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the code, you&#8217;ll want to add <code>CDEBUG</code> statements to print messages to the
ring buffer.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example <code>CDEBUG</code> message printed in the LNet code path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">CDEBUG(D_NET, "Allocate new FMR pool\n");</code></pre>
</div>
</div>
<div class="paragraph">
<p>These messages won&#8217;t be present in the ring buffer by default unless you add
<code>net</code> to the debug parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">lctl set_param debug=+net</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then trigger some LNet activity by pinging another network interface
over LNet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">lctl ping 192.168.0.103@o2ib</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, dump the contents of the ring buffer to a file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">lctl dk &gt; /tmp/dk.log</code></pre>
</div>
</div>
<div class="paragraph">
<p>And see your message somewhere in the output file <code>/tmp/dk.log</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing_lnet_dev_changes"><a class="anchor" href="#_testing_lnet_dev_changes"></a>Testing LNet Dev Changes</h3>
<div class="paragraph">
<p>You can&#8217;t hot swap the kernel modules. The old ones must be unloaded and new
ones loaded. Most likely, you won&#8217;t actually need the filesystem mounted; you&#8217;ll
just need LNet loaded and configured. You can skip dealing with RPMs by loading
the <code>.ko</code> files out of the source tree after running <code>make</code>. You can find the
paths of these built <code>.ko</code> files by running the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">mawenzi-06:~ # find lustre-wc-rel/ -name "*.ko"
lustre-wc-rel/libcfs/libcfs/libcfs.ko
lustre-wc-rel/lnet/klnds/o2iblnd/ko2iblnd.ko
lustre-wc-rel/lnet/klnds/socklnd/ksocklnd.ko
lustre-wc-rel/lnet/lnet/lnet.ko
lustre-wc-rel/lnet/selftest/lnet_selftest.ko
lustre-wc-rel/lustre/fid/fid.ko
lustre-wc-rel/lustre/fld/fld.ko
lustre-wc-rel/lustre/llite/lustre.ko
lustre-wc-rel/lustre/lmv/lmv.ko
lustre-wc-rel/lustre/lov/lov.ko
lustre-wc-rel/lustre/mdc/mdc.ko
lustre-wc-rel/lustre/mgc/mgc.ko
lustre-wc-rel/lustre/obdclass/llog_test.ko
lustre-wc-rel/lustre/obdclass/obdclass.ko
lustre-wc-rel/lustre/obdecho/obdecho.ko
lustre-wc-rel/lustre/osc/osc.ko
lustre-wc-rel/lustre/ptlrpc/ptlrpc.ko
lustre-wc-rel/lustre/tests/kernel/kinode.ko</code></pre>
</div>
</div>
<div class="paragraph">
<p>Insert the LNet kernel modules from the local paths. This is for an o2ib net.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">lustre="/root/lustre-wc-rel"
insmod $lustre/libcfs/libcfs/libcfs.ko
insmod $lustre/lnet/lnet/lnet.ko
insmod $lustre/lnet/klnds/o2iblnd/ko2iblnd.ko</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re changing userspace tools then you want to manipulate <code>PATH</code> so that it
finds your built binaries/scripts first instead of the ones installed by
previous RPMs (unless you remove the rpms beforehand):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">lustre="/root/lustre-wc-rel"
export PATH="$lustre/lustre/utils:$lustre/lnet/utils:$lustre/lustre/scripts:$PATH"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s a script I set up to do all the above in one go:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

echo -e "Make sure you've checked out your latest changes with git and have run ./configure"

set -ex

# Uninstall the old stuff if it exists
for entry in $(mount -t lustre | awk '{print $3}'); do
	echo "Unmounting $entry"
	umount -t lustre $entry
done
which lustre_rmmod &amp;&amp; lustre_rmmod
#zypper remove --no-confirm lustre-client lustre-client-dkms lustre-client-kmp-default

# Build the client utils/binaries and kernel objects (.ko)
lustre="/root/lustre-wc-rel"
cd $lustre
make -j 16

# Insert kernel modules, and configure bin/sbin tools
export PATH="$lustre/lustre/utils:$lustre/lnet/utils:$lustre/lustre/scripts:$PATH"
insmod $lustre/libcfs/libcfs/libcfs.ko
insmod $lustre/lnet/lnet/lnet.ko
insmod $lustre/lnet/klnds/o2iblnd/ko2iblnd.ko
insmod $lustre/lnet/klnds/socklnd/ksocklnd.ko
cp lustre-wc-rel/lustre/scripts/ksocklnd-config /usr/sbin

# Configure LNet
lnetctl lnet configure
lnetctl net add --net o2ib --if ib0
lnetctl net add --net tcp --if eth0
lctl network up
lnetctl net show

# Run debugging steps
lctl set_param debug=+net
lctl ping 192.168.0.103@o2ib
lctl ping 10.214.130.4@tcp
lctl dk &gt; /tmp/dk.log</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: <code>ksocklnd-config</code> script manipulates ip routes/rules. This can
potentially break things in ClusterStor or Shasta because the IP network
config is already defined a certain way. You can avoid calling it on net add
by passing an option:</p>
</div>
<div class="paragraph">
<p><code>lnetctl net add --skip-mr-route-setup &#8230;&#8203;</code></p>
</div>
<div class="paragraph">
<p>There&#8217;s also a kernel module parameter:</p>
</div>
<div class="paragraph">
<p><code>options ksocklnd  skip_mr_route_setup=1</code></p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_kernel_module_parameters"><a class="anchor" href="#_configuring_kernel_module_parameters"></a>Configuring Kernel Module Parameters</h3>
<div class="paragraph">
<p>You can pass the args to <code>insmod</code> when inserting the module to establish module
parameter values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cassini-hosta:/home/hornc/lustre-wc-rel # insmod libcfs/libcfs/libcfs.ko libcfs_debug=-1
cassini-hosta:/home/hornc/lustre-wc-rel # cat /sys/module/libcfs/parameters/libcfs_debug
-1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>modprobe</code>, which uses <code>insmod</code> under the hood, lets you set up <code>.conf</code> files
for modules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cassini-hosta:/home/hornc/lustre-wc-rel # cat /etc/modprobe.d/lustre.conf
options ksocklnd  skip_mr_route_setup=1
options libcfs cpu_npartitions=8 cpu_pattern=""
options kkfilnd traffic_class=bulk_data
options lnet ip2nets="tcp(heth0) 172.18.2.[5-6]; tcp(enp137s0f0np0) 172.18.2.[7-8]"
options lnet lock_prim_nid=1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Otherwise, the source of these parameters all live under <code>/sys/module/&lt;module&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cassini-hosta:/home/hornc/lustre-wc-rel # cat /sys/module/lnet/parameters/lnet_transaction_timeout
50
cassini-hosta:/home/hornc/lustre-wc-rel # cat /sys/module/lnet/parameters/sock_timeout
0</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_lnet_sanity_tests_locally"><a class="anchor" href="#_running_lnet_sanity_tests_locally"></a>Running LNet Sanity Tests Locally</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># After ./configure &amp;&amp; make -j 16 ...
cd lustre-wc-rel/lustre/tests/
./auster -Nv sanity-lnet --only 232</code></pre>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright © 2023-2025 Caleb Carlson. All rights reserved.
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
